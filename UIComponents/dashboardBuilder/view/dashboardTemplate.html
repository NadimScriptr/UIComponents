<html ng-app="myApp">
<head>
	<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="shortcut icon" type="image/x-icon" href="https://www.scriptr.io/themes/scriptr/images/favicon.ico">
    <title>Dashboard Builder</title>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="//use.fontawesome.com/3d61d6959e.js"></script>
    <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,700" rel="stylesheet">
  
    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/jquery.slick/1.6.0/slick.css"/>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.css">
    <link rel="stylesheet" href="/UIComponents/dashboard/frontend/components/chart/chart.css">
    <link rel="stylesheet" href="/UIComponents/dashboard/frontend/components/searchBox/abn_tree.css">
    <link rel="stylesheet" href="/UIComponents/dashboardBuilder/lib/gridster/angular_gridster.min.css">
    <link rel="stylesheet" href="//cdn.gitcdn.link/cdn/angular/bower-material/v1.1.3/angular-material.css">
    <link rel="stylesheet" href="/UIComponents/dashboard/frontend/components/odometer/odometer.car.css">
    <link rel="stylesheet" href="/UIComponents/dashboard/frontend/components/thermometer/style.css">
    <link href="//cdnjs.cloudflare.com/ajax/libs/angular-xeditable/0.7.0/css/xeditable.css" rel="stylesheet">
    <link rel="stylesheet" href="/UIComponents/dashboard/frontend/components/ACL/ACL.css">
    <link rel="stylesheet" href="/UIComponents/dashboard/frontend/components/gauge/gauge.css">
    <link rel="stylesheet" href="/UIComponents/dashboard/frontend/components/grid/grid.css">
    <link href="/UIComponents/dashboard/frontend/components/list/angucomplete.alt.css" rel="stylesheet">
    <link rel="stylesheet" href="/UIComponents/dashboard/frontend/components/map/map.css">
    <link href="/UIComponents/dashboard/frontend/components/toggleSwitch/angular_toggle_switch.css" media="all" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/UIComponents/dashboardBuilder/lib/schemaForm/select.min.css">
    
    <link href="//cdnjs.cloudflare.com/ajax/libs/angular-bootstrap-colorpicker/3.0.31/css/colorpicker.min.css" rel="stylesheet">
    <link href="//cdnjs.cloudflare.com/ajax/libs/angularjs-slider/6.2.2/rzslider.css" media="all" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/UIComponents/dashboard/frontend/components/button/button.css">
    <link href="/UIComponents/dashboard/frontend/components/IFrame/IFrame.css" media="all" rel="stylesheet" type="text/css">
    <link rel="stylesheet"  href="/UIComponents/dashboard/frontend/components/accelerometer/accelerometer.css"/>
    <link href="/UIComponents/dashboardBuilder/lib/schemaForm/spectrum.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.27.4/codemirror.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.27.4/theme/neo.min.css">
  	<link rel="stylesheet" href="/UIComponents/dashboard/frontend/components/dygraphs/dygraphs-2.1.0.css">
    <link rel="stylesheet" href="/UIComponents/dashboard/frontend/components/displayCount/count.css">
    <link rel="stylesheet" href="/UIComponents/dashboard/frontend/components/slider/slider.css">
    
    <link rel="stylesheet" href="/UIComponents/dashboard/frontend/components/plotly/windrose.css">
     <link rel="stylesheet" href="/UIComponents/dashboard/frontend/components/common/notifications.css"/>
    <link rel="stylesheet" href="/UIComponents/dashboardBuilder/css/markdown.css">

    <link rel="stylesheet" href="/UIComponents/dashboardBuilder/css/media.css">
     
    <link rel="stylesheet" href="/UIComponents/dashboardBuilder/css/{{dashboardSettings.theme}}.css">
    
  
    <!-- JQUERY Material  To use jQuery, simply ensure it is loaded before the angular.js file. -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js" ></script>
  
    <!-- Libraries -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>	
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.6/handlebars.js"></script>
    
    
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.21/moment-timezone-with-data.min.js"></script>

    
    <script id="mapsScript" src="//maps.google.com/maps/api/js?key=AIzaSyBcPYghFh_BXz4dDz-TXTHbU2iV3Wbf57I&libraries=drawing,visualization"></script>
  
    <!-- Login -->
    <script src="/modules/login/widgets/authorization.js"></script>
  
    <!-- NG material -->
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular-route.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular-cookies.js"></script>
    <script src="//cdn.rawgit.com/gdi2290/angular-websocket/v1.0.9/angular-websocket.min.js"></script>
    <script src="/UIComponents/dashboardBuilder/lib/gridster/angular_gridster.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular-animate.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular-sanitize.js"></script>
    <script src="/UIComponents/dashboardBuilder/lib/schemaForm/angular-underscore.js"></script>
    <script src="/UIComponents/dashboardBuilder/lib/schemaForm/angular-translate.min.js"></script>
    <script src='/UIComponents/dashboardBuilder/lib/schemaForm/select.min.js'></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/2.5.0/ui-bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/2.5.0/ui-bootstrap-tpls.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-messages.min.js"></script>      
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-aria.min.js"></script> 
    <script src="/UIComponents/dashboard/frontend/components/map/markerClusterer.js"></script>
  
    <!-- Directives -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.4/raphael-min.js"></script>
	<script src="//d3js.org/d3.v4.min.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/chart/morris.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/chart/angular.morris.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/gauge/justgauge.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/gauge/angular.gauge.min.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/speedometer/angular.metergauge.min.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/odometer/odometer.min.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/odometer/angular.odometer.min.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/thermometer/thermometer_directive.js"></script>
    <script src="//rawgit.com/allenhwkim/angularjs-google-maps/master/build/scripts/ng-map.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/ag-grid/12.0.0/ag-grid.js?ignore=notused36"></script>
    <script src="/UIComponents/dashboard/frontend/components/toggleSwitch/angular_toggle_switch.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/angularjs-slider/6.2.2/rzslider.min.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/button/angular-promise-buttons.js"></script>
    <script src="/UIComponents/dashboardBuilder/lib/schemaForm/tv4.js"></script>
    <script src="/UIComponents/dashboardBuilder/lib/schemaForm/objectPath.js"></script>
    <script src="/UIComponents/dashboardBuilder/lib/schemaForm/schemaForm.js"></script>
    <script src="/UIComponents/dashboardBuilder/lib/schemaForm/bootstrapDecorator.js"></script>
    <!-- Components -->
    <script src="/UIComponents/wsProvider.js"></script>
    <script src="/UIComponents/httpProvider.js"></script>
    <script src="/UIComponents/dataService.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/chart/chart.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/odometer/odometer.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/speedometer/speedometer.js"></script>
    <script src="/UIComponents/dashboardBuilder/javascript/components/module.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/gauge/gauge.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/alert/ngScriptrAlert.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/alert/alert.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/thermometer/thermometer.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/progressBar/progressBar.js"></script> 
    <script src="/UIComponents/dashboard/frontend/components/map/map.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/grid/grid.js"></script>
    
    
    <script src="/UIComponents/dashboard/frontend/components/dygraphs/dygraphs-2.1.0.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/dygraphs/angular-dygraphs.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/dygraphs/dygraphs.js"></script>
    
    <script src="/UIComponents/dashboard/frontend/components/toggleSwitch/toggle_switch.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/slider/slider.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/button/button.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/IFrame/IFrame.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/accelerometer/accelerometer.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/displayCount/displayCount.js"></script>
    
    <script src="//cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/plotly/angular-plotly.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/plotly/plotly.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/plotly/3dsurface.js"></script>
    <script src="/UIComponents/dashboard/frontend/components/plotly/windrose.js"></script>
    
    <script src="/UIComponents/dashboard/frontend/components/common/notifications.js"></script>
        
</head> 
  
  
<style>
  {{compiledCss}}
</style>
<style>
  {{dashboardSettings.inline-style}}
</style>

<script>

(function() {
	
  if("{{{dashboardSettings.requiresLogin}}}" == "Yes"){
  
   var scriptName = window.location.pathname.substring(1,window.location.pathname.length )
   var loginTemplateTarget ="/UIComponents/dashboardBuilder/loginTemplate.html?redirectTarget="+scriptName+"&anon_token={{{anon_token}}}"

    var authorization  = $.scriptr.authorization(
        {
          onTokenValid: function(){ }, 
          loginPage: loginTemplateTarget
        }
      );
    }
  
  
   $.urlParam = function(name){
	     var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
	     if (results==null){
	         return null;
	     }else{
	         return results[1] || 0;
	     }
	}

	$.getUrlVars = function() {
		var vars = [], hash;
		var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
		for(var i = 0; i < hashes.length; i++)
		{
			hash = hashes[i].split('=');
			vars.push(hash[0]);
			vars[hash[0]] = hash[1];
		}
		return vars;
	}
    
    var underscore = angular.module('underscore', []);
		underscore.factory('_', ['$window', function($window) {		
  		return $window._; // assumes underscore has already been loaded on the page		
	}]);
    

    var wssConfig = ["wsClientProvider",function (wsClientProvider) {
   	 	wsClientProvider.setBaseUrl("wss://" + window.location.host + "/");   	 
        wsClientProvider.setToken($.urlParam("auth_token"));
        wsClientProvider.setPublishChannel("{{{dashboardSettings.publishChannel}}}");
        wsClientProvider.setSubscribeChannel("{{{dashboardSettings.subscribeChannel}}}");
    }];

    var httpsConfig = ["httpClientProvider",function (httpClientProvider) {
   	  httpClientProvider.setBaseUrl("https://" + window.location.host);
      httpClientProvider.setToken($.urlParam("auth_token"));
    }]

     var myApp= angular.module("myApp", ["underscore" , "WsClient", "HttpClient", "Chart", 'gridster', 'ui.bootstrap', 'ngRoute', 'Gauge', 'Speedometer', 'Odometer', 'Map', 'Grid', 'toggle-switch', 'Slider', 'Button', 'IFrame', 'Accelerometer', 'Thermometer', 'Display', "ngAnimate", "ngSanitize", 'Dygraphs', 'DataService', 'Plotly', 'Alert'])
     angular.module('myApp').config(wssConfig);
     angular.module('myApp').config(httpsConfig);
     
     myApp.config(function($interpolateProvider, $locationProvider) {
        $interpolateProvider.startSymbol('{[{');
        $interpolateProvider.endSymbol('}]}');
        $locationProvider.html5Mode({
          enabled: true,
          requireBase: false
        });
     });
  
  
     myApp.controller('RootCtrl', function($scope, $interpolate, $location, dataService, $interval) {
       var vm = this;
       vm.gridsterOptions = {
          defaultSizeY: 50,
          defaultSizeX:50,
          minRows: 1, // the minimum height of the grid, in rows
          maxRows: 100,
          columns: 10, // the width of the grid, in columns
          colWidth: 'auto', // can be an integer or 'auto'.  'auto' uses the pixel width of the element divided by 'columns'
          rowHeight: '50', // can be an integer or 'match'.  Match uses the colWidth, giving you square widgets.
          margins: [10, 10], // the pixel distance between each widget
          defaultSizeX: 2, // the default width of a gridster item, if not specifed
          defaultSizeY: 1, // the default height of a gridster item, if not specified
          mobileBreakPoint:480, // if the screen is not wider that this, remove the grid layout and stack the items
          minColumns: 1, // the minimum columns the grid must have
          resizable: {
            enabled: false
          },
          draggable: {
             enabled: false
          }
       };
       
        vm.init = function() {
          {{#each urlParams}}
           	console.log("{{this}}", $location.search()["{{this}}"])
            vm.{{this}} = $location.search()["{{this}}"]
          {{/each}}
          
          {{#if dashboardSettings.transport}}
          		   vm.refreshTimer = null;
          		   vm.data = null;
                   vm.dashboardSettings = {
                        {{#if dashboardSettings.api}}    "api": "{{dashboardSettings.api}}", {{/if}}
                        {{#if dashboardSettings.transport}}    "transport": "{{dashboardSettings.transport}}", {{/if}}
                        {{#if dashboardSettings.msg-tag}}    "msgTag": "{{dashboardSettings.msg-tag}}", {{/if}}
                        {{#if dashboardSettings.api-params}}    "apiParams": "{{dashboardSettings.api-params}}", {{/if}}
                        {{#if dashboardSettings.use-window-params}}    "useWindowParams": "{{dashboardSettings.use-window-params}}", {{/if}}
                        {{#if dashboardSettings.http-method}}    "httpMethod": "{{dashboardSettings.http-method}}", {{/if}}
                        {{#if dashboardSettings.fetch-data-interval}}"fetchDataInterval": "{{dashboardSettings.fetch-data-interval}}", {{/if}}
                        "widgetId": $scope.$id
                        
                    };
                    
                    
                    vm.initDashboardDataService();
                    
                    
                    $scope.$on("waiting-for-data", function() {
                      	vm.consumeData(vm.data)
                    })
           {{/if}}
        }
        
        {{#if dashboardSettings.transport}}
            vm.initDashboardDataService =  function() {

                        var requestInfo = {
                                "api": vm.dashboardSettings.api,
                                "transport": vm.dashboardSettings.transport,
                                "msgTag": vm.dashboardSettings.msgTag,
                                "apiParams": vm.dashboardSettings.apiParams,
                                "useWindowParams": vm.dashboardSettings.useWindowParams,
                                "httpMethod": vm.dashboardSettings.httpMethod,
                                "widgetId": vm.dashboardSettings.widgetId
                           };
                           dataService.scriptrRequest(requestInfo, vm.consumeData.bind(vm));

                          if(vm.dashboardSettings["fetchDataInterval"] != null && vm.refreshTimer == null) {
                              //Assuming this is success
                              self.refreshTimer = $interval(
                                  function(){
                                     vm.initDashboardDataService()
                                  }, vm.dashboardSettings["fetchDataInterval"]  * 1000);
                          }

            }
            
             vm.consumeData = function(data, response) {
                vm.data = data;
                $scope.$broadcast("update-data", data);
            }
        
         {{/if}}
        
        
        {{#each items}}
           	{{#if this.formatFunction}}   
                vm.{{this.formatFunction}} = function(data){
                  {{{this.formatFunctionValue}}}
                }
           	{{/if}} 
        {{/each}}
        
        /**{{#each items}}
           	{{#if this.functions}}   
            	{{#each this.functions}}
                    vm.{{this.name}} = function(arguments){
                      {{{this.value}}}
                    }
                 {{/each}}
           	{{/if}} 
        {{/each}}**/
     });
        	
})();
  
</script>

   <body class="dashboard-template dashboardTheme ">
      <div ng-controller="RootCtrl as vm" ng-init="vm.init();" class="dashboardContainer"> 
		<div gridster="vm.gridsterOptions">
          <ul>
             {{#each items}}
                <li class="myItem {{#if_eq  fitToWidget true}} fit-to-widget {{/if_eq}}" gridster-item='{sizeX: {{sizeX}}, sizeY: {{sizeY}}, col: {{col}} , row: {{row}} }'>
                    
						<div class="box {{#if_eq  this.options.boxHeader "false"}} box-without-header {{/if_eq}} {{#if_eq  this.options.boxHeader false}} box-without-header {{/if_eq}}">
						  <div class="box-header">
						    <div class="box-label"><span tooltip-append-to-body="true" uib-tooltip="{{this.options.boxLabel}}">{{this.options.boxLabel}}</span></div>
						  </div>
                          <div class="clearfix"></div>
						  <div class="box-content">
						  		<{{type}}
                                    {{#buildAttr this.options }}
                                        {{this}}
                                    {{/buildAttr}}
                                    {{#if this.formatFunction}}   
                                  		on-format-data='vm.{{this.formatFunction}}'
                                    {{/if}} 
                           		>
                                
                                {{#if this.functions}}   
                                       {{#each this.functions}}
                                  			{{this.attribute}}='vm.{{this.name}}'
                                        {{/each}}
                                    {{/if}} 
                                   
 
 
          
 					{{#if this.options.default-info-window}}
                                <info-window id="{{this.options.default-info-window.id}}" template="{{this.options.default-info-window.template}}" max-width="{{this.options.default-info-window.max-width}}" max-height="{{this.options.default-info-window.max-height}}">
                                 </info-window>
                    {{/if}}
                    
       			{{#if this.options.source-info-window}}
                    	{{#each this.options.source-info-window}}
                        		 <info-window id="infoWindowTemplate_{{this.source}}" template="{{this.template}}" max-width="{{this.max-width}}" max-height="{{this.max-height}}">
                                 </info-window>
                        {{/each}}
                    {{/if}}
                                </{{type}}>
						  </div>
						</div>
                </li>
             {{/each}}
          </ul>
        </div>
      </div>
  </body>  
</html>